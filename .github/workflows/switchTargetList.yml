name: Switch PR Target List

on:
  pull_request:
    types: [labeled, unlabeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  switch-target:
    runs-on: ubuntu-latest

    if: |
      contains(github.event.pull_request.labels.*.name, 'target:blocklist') ||
      contains(github.event.pull_request.labels.*.name, 'target:warnlist')

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}

      - name: Determine target and current state
        id: analyze
        run: |
          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
          
          # Determine target from labels
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          
          if echo "$LABELS" | grep -q "target:blocklist"; then
            TARGET_LIST="blocklist"
            TARGET_FILE="AiSList/aislist_blocklist.txt"
            OTHER_FILE="AiSList/aislist_warnlist.txt"
          elif echo "$LABELS" | grep -q "target:warnlist"; then
            TARGET_LIST="warnlist"
            TARGET_FILE="AiSList/aislist_warnlist.txt"
            OTHER_FILE="AiSList/aislist_blocklist.txt"
          else
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "target_list=$TARGET_LIST" >> $GITHUB_OUTPUT
          echo "target_file=$TARGET_FILE" >> $GITHUB_OUTPUT
          echo "other_file=$OTHER_FILE" >> $GITHUB_OUTPUT
          
          # Check which file is modified in this PR
          CHANGED_FILES=$(git diff --name-only "$BASE_REF")
          
          if echo "$CHANGED_FILES" | grep -q "aislist_blocklist.txt"; then
            CURRENT_FILE="AiSList/aislist_blocklist.txt"
            CURRENT_LIST="blocklist"
          elif echo "$CHANGED_FILES" | grep -q "aislist_warnlist.txt"; then
            CURRENT_FILE="AiSList/aislist_warnlist.txt"
            CURRENT_LIST="warnlist"
          else
            echo "No list file modified in PR"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "current_file=$CURRENT_FILE" >> $GITHUB_OUTPUT
          echo "current_list=$CURRENT_LIST" >> $GITHUB_OUTPUT
          
          # Extract channel - get all added lines starting with @
          CHANNEL=$(git diff "$BASE_REF" -- "$CURRENT_FILE" | grep "^+@" | sed 's/^+//' | head -n 1 | tr -d '[:space:]')
          
          if [ -z "$CHANNEL" ]; then
            echo "No channel found in diff"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          
          # Debug output
          echo "::notice::Target: $TARGET_LIST, Current: $CURRENT_LIST, Channel: $CHANNEL"

      - name: Switch target if needed
        if: steps.analyze.outputs.skip != 'true'
        id: switch
        run: |
          CURRENT_LIST="${{ steps.analyze.outputs.current_list }}"
          TARGET_LIST="${{ steps.analyze.outputs.target_list }}"
          CURRENT_FILE="${{ steps.analyze.outputs.current_file }}"
          TARGET_FILE="${{ steps.analyze.outputs.target_file }}"
          CHANNEL="${{ steps.analyze.outputs.channel }}"
          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"
          
          # If target matches current, no action needed
          if [ "$CURRENT_LIST" = "$TARGET_LIST" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Target already correct ($TARGET_LIST)"
            exit 0
          fi
          
          echo "Switching from $CURRENT_LIST to $TARGET_LIST"
          echo "Channel: $CHANNEL"
          
          # Reset BOTH files to base branch state
          git checkout "$BASE_REF" -- "$CURRENT_FILE" "$TARGET_FILE"
          
          # Add channel to target file (append before sorting or at end)
          echo "$CHANNEL" >> "$TARGET_FILE"
          
          # Update metadata
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          TARGET_CHANNELS=$(grep -c "^@" "$TARGET_FILE" || echo "0")
          
          # Update Last Modified date (line 6)
          sed -i "6s/! Last Modified: .*/! Last Modified: $CURRENT_DATE/" "$TARGET_FILE"
          
          # Update Total Channels count
          sed -i "s/^! Total Channels: .*/! Total Channels: $TARGET_CHANNELS/" "$TARGET_FILE"
          
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "from=$CURRENT_LIST" >> $GITHUB_OUTPUT
          echo "to=$TARGET_LIST" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.analyze.outputs.skip != 'true' && steps.switch.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage both files explicitly
          git add "${{ steps.analyze.outputs.current_file }}" "${{ steps.analyze.outputs.target_file }}"
          
          # Check if there are actual changes to commit
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "chore: switch target from ${{ steps.switch.outputs.from }} to ${{ steps.switch.outputs.to }}"
          git push

      - name: Post success comment
        if: steps.analyze.outputs.skip != 'true' && steps.switch.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **Target list switched**\n\nChanged from **${{ steps.switch.outputs.from }}** to **${{ steps.switch.outputs.to }}**\n\nChannel \`${{ steps.analyze.outputs.channel }}\` now targets \`${{ steps.analyze.outputs.target_file }}\``
            })

      - name: Post no-change comment
        if: steps.analyze.outputs.skip != 'true' && steps.switch.outputs.changed == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ℹ️ Target list is already set to **${{ steps.analyze.outputs.target_list }}**\n\nNo changes needed.`
            })
