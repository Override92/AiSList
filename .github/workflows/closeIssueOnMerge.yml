name: Close Matching Issue on PR Merge

on:
  pull_request_target:
    types: [closed]

permissions:
  issues: write
  pull-requests: write

jobs:
  close-and-label:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Find matching issue (case-insensitive)
        id: find
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = context.payload.pull_request.title.trim().toLowerCase();
            console.log("PR Title:", prTitle);

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              per_page: 100
            });

            let match = null;

            for (const issue of issues.data) {
              const issueTitle = issue.title.trim().toLowerCase();
              console.log("Comparing:", prTitle, "vs", issueTitle);

              if (issueTitle === prTitle) {
                match = issue;
                break;
              }
            }

            if (match) {
              console.log("Match found: Issue #" + match.number);
              core.setOutput("issue_number", match.number);
            } else {
              console.log("No matching issue found");
              core.setOutput("issue_number", "");
            }

      - name: Close the matching issue
        if: steps.find.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.find.outputs.issue_number }},
              state: "closed"
            });

      - name: Add label to the closed issue
        if: steps.find.outputs.issue_number != ''
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: implemented
          number: ${{ steps.find.outputs.issue_number }}
          repo: ${{ github.repository }}
